---
import { Icon } from "astro-icon/components";
import { Octokit } from "octokit";

import { URLs, siteMetadata } from "~/constants";
import type { RepoStats } from "~/types";

const octokit = new Octokit();

const formatCount = (count: number) => {
  return new Intl.NumberFormat("en", {
    notation: "compact",
    maximumFractionDigits: 1,
  }).format(count);
};

const loadRepoStats = async (): Promise<RepoStats> => {
  try {
    const repository = await octokit.rest.repos.get({
      owner: siteMetadata.repo.owner,
      repo: siteMetadata.repo.name,
    });

    return {
      stars: formatCount(repository.data.stargazers_count),
    };
  } catch (error) {
    console.error("Failed to load repo stats", error);
    return {
      stars: "",
    };
  }
};

const { stars } = await loadRepoStats();
---

<a
  href={URLs.GITHUB.REPO}
  target="_blank"
  rel="noopener noreferrer"
  aria-label="GitHub Repository"
  class="text-white hover:text-red-300 hover:no-underline"
>
  <section class="flex flex-row items-center">
    <Icon name="mdi:github" size={32} class="w-6 md:w-10" />
    <div class="font-light flex items-center gap-1">
      <div class="text-sm max-lg:text-xs max-md:hidden">{siteMetadata.repo.name}</div>
      <Icon name="mdi:star-outline" />
      <div class="text-xs">{stars}</div>
    </div>
  </section>
</a>
